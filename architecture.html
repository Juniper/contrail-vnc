<!DOCTYPE html>
<html lange="en">
  <head>
    <title>Contrail architecture</title>
    <link rel='stylesheet' id='twentythirteen-style-css'  href='http://www.opencontrail.org/wp-content/themes/twentythirteen-child/style.css?ver=2013-07-18' type='text/css' media='all' />
    <link rel='stylesheet' id='twentythirteen-fonts-css'  href='//fonts.googleapis.com/css?family=Source+Sans+Pro%3A300%2C400%2C700%2C300italic%2C400italic%2C700italic%7CBitter%3A400%2C700&#038;subset=latin%2Clatin-ext' type='text/css' media='all' />

  </head>
  <body>
    <div class="entry-content">
      <h1>Software architecture</h1>
    </div>
    <div class="entry-content">
      <p>The Contrail <span>Virtual Network Controller (VNC)</span> is composed of the
following components:
<ul>
  <li><p>Configuration node</p>
    <p>The configuration node provides a REST API that allows an orchestration system to define virtual-networks, virtual-interfaces and network policies that control the flow of traffic between virtual-networks. The configuration node is responsible to store the persistent state of the system that defines the desired  state of the network.</p>
  </li>
  <li><p>Control node</p>
  <p>The control node implements a distributed database that contains the effemeral state of the system. Control nodes federate with each other using the BGP routing protocol. BGP is also used to communicate with network virtualization enabled routers that support the BGP/MPLS L3VPN protocol.</p>
  <p>Control nodes distribute network reachability information to compute-nodes using the XMPP protocol. The same channel is used to distribute desired network configuration state such as the properties of virtual-network interfaces instantiated in a specific compute-node.</p>
  </li>
  <li><p>Analytics engine</p>
    <p>The network analytics engine collects information such as network flow records from the compute-nodes and makes them available via a REST API. Additionally each of the contrail components periodically reports status information about its state and the state of primary data objects in the system.
    </p>
  </li>
  <li><p>Compute node</p>
    <p>The compute node includes both a user space process (agent) as well as dataplane component that executes as a loadable kernel module on the Host operating system.</p>
  </li>
</ul>
      </p>
      <div style="text-align:center">
	<img src="view.jpg">
      </div>
    </div>

    <div class="entry-content">
      <h2>Configuration node</h2>
      <p>The <a href="http://www.trustedcomputinggroup.org/files/resource_files/2888CAD9-1A4B-B294-D0ED95712B121FEF/TNC_IFMAP_v2_1r15.pdf">IF-MAP</a> specification defines a set of base operations that can be used to store and query an object graph. The contrail VNC defines an object model (<a href="https://github.com/Juniper/contrail-controller/blob/master/src/schema/vnc_cfg.xsd">vnc_cfg.xsd</a>)
that expresses network virtualization concepts as IF-MAP identifiers and metadata relations.</p>
      <p>The configuration node APIs are <a href="https://github.com/Juniper/contrail-generateDS">autogenerated</a> from this schema.</p>

      <p>Several APIs expose higher level concepts that need to be translated to lower level objects. For instance a network-policy may result in both a "access-control list" (ACL) as well as importing network reachability accross virtual-networks. The ACL is implemented by the data-plane, while the routing information import/export function is implemented by the control-node. The "schema-transformer" process performs this function whenever necessary.</p>

      <div style="text-align:center">
	<img src="config-node.jpg"/>
      </div>

      <p>The configuration node is composed of multiple processes:
	<ul>
	  <li><p>API server</p>
	    <p>The API server is responsible for persisting the state of
	    the schema objects as well as publishing the corresponding information in the IF-MAP server. It also implements additional functionality such as
IP address management.</p>
	  </li>
	  <li><p>Schema transformer</p>
	    <p>The schema transformer converts higher level concepts into low level objects that can be implemented by the network. For instance it allocates
one or more 
<quote>routing-instance</quote> objects for a virtual-network. Routing instances correspond to VRF in the dataplane.</p>
	  </li>
	  <li><p>Service monitor</p>
	    <p>The service monitor process creates and monitors virtual-machine instances that implement network services such as NAT or firewalls.</p>
	  </li>
	  <li><p>Discovery Service</p>
	    <p>The discovery service publishes the IP address and port of
	      the multiple components of the configuration node. The system run multiple instance of each process for high-availability and load balancing purposes.
	    </p>
	  </li>
	  <li><p>Domain Name (DNS) Server</p>
	    <p>Multi-tenant aware DNS server.</p>
	  </li>
	</ul>
      </p>
    </div>


    <div class="entry-content">
      <h2>Control node</h2>

      <p>The control-node implements an in-memory distributed database that
	contains the transient state of the network such as the current
	network reachability information.
      </p>
      <p>For each virtual-network defined at the configuration level, there is
	exists one or more routing-instances that contain the corresponding
	network reachabilibity. A routing-instance contains the IP host routes
	of virtual-machines in the network as well as the routing information
	corresponding to other virtual-networks to which virtual-machines are
	allowed to communicate directly with.
      </p>
      <p>Control-node processes federate with each other using the BGP protocol and specifically the BGP/MPLS L3VPN extensions. The same protocol is used to interoerate with physical routers that support network virtualization.
      </p>
      <p>The control-node also contains an IF-MAP subsystem which is
	reponsible to filter the configuration database and propagate to
	the compute node agents only the subset of configuration information
	that is relevant to them.
      </p>
      <p>Communication between the control-node and the agent is done via
      an XMPP-like control channel. While the message format follows the
      XMPP specification the state machine does not yet. This will be
      corrected whenever possible.</p>
      <p>The control-node receives "subcription" messages from the agent
      for routing information on specific routing-instances and for
      configuration information pertaining to virtual-machines instantiated
      in the respective compute node. It then pushes any current information
      as well as updates to both routing and configuration objects relevant
      to each agent.
	Each agent connects to two control-nodes in an active-active model.
      </p>
      <p>All the routing functionality in the system happens at the
      control node level. The agent is unaware of policies that influence
      which routes are present in each routing table.</p>
      <div style="text-align:center">
	<img src="control-node.jpg"/>
      </div>

    </div>

    <div class="entry-content">
      <h2>Analytics Engine</h2>
      <p>The Analytics node provides a REST interface to a time series database
	containing the state of various objects in the system such as
	virtual-networks, virtual-machines, configuration and control nodes
	as well as traffic flow records.
      </p>
      <p>The collected data is stored in a DHT/NoSQL distributed database
	(Apache Cassandra)
	for scale-out.
      </p>
      <p>The collected objects are defined using an <a href="https://github.com/Juniper/contrail-sandesh">IDL</a> so that the schema of database records can
	be easily communicated to users or applications performing queries.
	This IDL unifies all diagnostics information on the system including data available through the HTTP interface provided by each contrail process.
      </p>
      <p>Information can be collected periodically or based on event triggers.</p>
      <div style="text-align:center">
	<img src="analytics.jpg"/>
      </div>
    </div>

    <div class="entry-content">
      <h2>Compute node</h2>

      <p>The compute-node is composed of the vRouter "agent" and
	<a href="https://github.com/Juniper/contrail-vrouter">"datapath"</a>.
	The datapath runs as a loadable kernel module on the host (or dom0)
	operating system.
      </p>
      <p>The agent is a user-space process that communicates with the control node. It runs a thrift service that is used by the compute node plugin (e.g.
	nova or XAPI) to enable the virtual-interface associated with a
      virtual-machine instance.</p>
      <p>The dataplane associates each virtual interface with a VRF table
      and perfoms the overlay encapsulation functionality. It implements
      Access Control Lists (ACLs), NAT, multicast replication and mirroring.</p>
      <p></p>
      <div style="text-align:center">
	<img src="compute.jpg"/>
      </div>

    </div>
  </body>
</html>
